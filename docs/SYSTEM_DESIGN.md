# TerraTNT 系统设计文档

## 📋 目录
1. [系统架构](#系统架构)
2. [数据层设计](#数据层设计)
3. [处理层设计](#处理层设计)
4. [模型层设计](#模型层设计)
5. [应用层设计](#应用层设计)
6. [前端界面设计](#前端界面设计)
7. [技术栈](#技术栈)

---

## 🏗️ 系统架构

### 五层架构设计

```
┌─────────────────────────────────────────────────────────┐
│              用户交互层 (User Interface)                  │
│        Web Dashboard | REST API | CLI Tools              │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              应用层 (Application Layer)                   │
│   轨迹预测服务 | 可视化界面 | 评估系统                    │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                模型层 (Model Layer)                       │
│  CNN环境编码器 | LSTM编码器 | 目标分类器 | LSTM解码器    │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│              处理层 (Processing Layer)                    │
│  环境预处理 | 代价图生成 | 轨迹生成 | 数据增强           │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                数据层 (Data Layer)                        │
│   DEM | LULC | OSM | OORD轨迹 | 合成轨迹                 │
└─────────────────────────────────────────────────────────┘
```

---

## 📊 数据层设计

### 多源地理数据

| 数据源 | 类型 | 分辨率 | 用途 |
|--------|------|--------|------|
| **SRTM DEM** | 高程数据 | 30m | 地形特征提取 |
| **ESA WorldCover** | 土地覆盖 | 10m | 环境类型分类 |
| **OpenStreetMap** | 道路网络 | 矢量 | 路径约束 |
| **OORD** | 真实轨迹 | GPS | 速度模型训练 |
| **合成轨迹** | 生成数据 | 30m | 模型训练 |

### 数据存储结构

```
data/
├── raw/                    # 原始数据
│   ├── gee/               # GEE下载数据
│   ├── osm/               # OSM数据
│   └── oord/              # OORD数据
├── processed/             # 处理后数据
│   ├── utm_grid/          # UTM投影栅格
│   ├── synthetic_trajectories/  # 合成轨迹
│   └── speed_training/    # 速度训练数据
└── models/                # 训练好的模型
    └── saved/
```

---

## ⚙️ 处理层设计

### 1. 环境数据预处理

```python
环境数据预处理流程:
1. 投影转换 (WGS84 → UTM)
2. 地形特征提取 (slope, aspect, curvature)
3. 可通行域分析 (LULC + slope constraints)
4. 代价图生成 (multi-intent cost maps)
```

### 2. 轨迹生成管道

```python
轨迹生成流程:
1. 起终点采样 (距离≥80km)
2. 分层A*路径规划
   - 粗规划 (降采样10倍)
   - 细规划 (使用粗路径)
3. 路径平滑 (三次样条插值)
4. 速度预测 (XGBoost模型)
5. 运动学约束 (加速度、曲率)
```

### 3. 数据增强

```python
18通道环境地图生成:
- 通道1: DEM (归一化)
- 通道2: Slope (0-1)
- 通道3-4: Aspect (sin, cos)
- 通道5-14: LULC one-hot (10类)
- 通道15: Road layer
- 通道16: History heatmap
- 通道17: Goal map
- 通道18: Missing mask
```

---

## 🤖 模型层设计

### TerraTNT模型架构

```
输入:
├── 环境地图 (18, 128, 128)
├── 历史轨迹 (10, 2)
├── 候选目标 (100, 2)
└── 当前位置 (2,)

模型结构:
┌─────────────────────────────────────┐
│   CNN环境编码器 (ResNet-18)          │
│   输入: (18, 128, 128)               │
│   输出: (256,) 环境特征              │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│   LSTM历史编码器 (双层)              │
│   输入: (10, 2)                      │
│   输出: (128,) 历史特征              │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│   目标分类器                          │
│   输入: 环境特征 + 历史特征 + 候选目标│
│   输出: (100,) 目标概率分布          │
└─────────────────────────────────────┘
           ↓
┌─────────────────────────────────────┐
│   层次化LSTM解码器                    │
│   输入: 所有特征 + 选定目标           │
│   输出: (60, 2) 未来轨迹             │
└─────────────────────────────────────┘

输出:
├── 预测轨迹 (60, 2)
└── 目标概率 (100,)
```

### 损失函数

```python
Total Loss = α·Goal_Loss + β·ADE + γ·FDE

其中:
- Goal_Loss: 目标分类交叉熵损失
- ADE: 平均位移误差 (Average Displacement Error)
- FDE: 最终位移误差 (Final Displacement Error)
- α=0.3, β=0.5, γ=0.2
```

---

## 🚀 应用层设计

### 1. 轨迹预测服务

```python
class TrajectoryPredictionService:
    """轨迹预测服务"""
    
    def predict(self, 
                current_position: Tuple[float, float],
                history_trajectory: List[Tuple[float, float]],
                region: str) -> Dict:
        """
        实时轨迹预测
        
        Returns:
            {
                'predicted_trajectory': List[Tuple[float, float]],
                'confidence': float,
                'predicted_goal': Tuple[float, float],
                'prediction_time': float
            }
        """
        pass
    
    def batch_predict(self, 
                     trajectories: List[Dict]) -> List[Dict]:
        """批量预测"""
        pass
```

### 2. 评估系统

```python
评估指标:
- ADE (Average Displacement Error)
- FDE (Final Displacement Error)
- Goal Accuracy (目标预测准确率)
- Miss Rate (失败率)
- Inference Time (推理时间)

对比基线:
- Constant Velocity Model
- Social LSTM
- Trajectron++
```

### 3. 可视化系统

```python
可视化功能:
- 地图底图展示 (DEM + LULC)
- 历史轨迹绘制
- 预测轨迹绘制 (多模态)
- 候选目标标注
- 置信度热力图
- 误差分布图
```

---

## 🎨 前端界面设计

### 主界面布局

```
┌─────────────────────────────────────────────────────────┐
│  TerraTNT - 地面目标轨迹预测系统                          │
├─────────────────────────────────────────────────────────┤
│  [数据集] [模型] [预测] [评估] [可视化] [设置]            │
├──────────────────┬──────────────────────────────────────┤
│                  │                                      │
│  控制面板         │         主显示区域                    │
│                  │                                      │
│  ┌────────────┐ │  ┌──────────────────────────────┐   │
│  │ 区域选择   │ │  │                              │   │
│  │ □ Scottish │ │  │      交互式地图              │   │
│  │ □ Bohemian │ │  │                              │   │
│  │ □ Donbas   │ │  │   - 历史轨迹 (蓝色)          │   │
│  │ □ Carpathi │ │  │   - 预测轨迹 (红色)          │   │
│  └────────────┘ │  │   - 真实轨迹 (绿色)          │   │
│                  │  │   - 候选目标 (黄点)          │   │
│  ┌────────────┐ │  │                              │   │
│  │ 模型配置   │ │  └──────────────────────────────┘   │
│  │ 历史长度:10│ │                                      │
│  │ 预测长度:60│ │  ┌──────────────────────────────┐   │
│  │ 候选数:100 │ │  │     性能指标                  │   │
│  └────────────┘ │  │  ADE: 2.34m  FDE: 5.67m      │   │
│                  │  │  Goal Acc: 87.3%             │   │
│  [开始预测]      │  │  Time: 45ms                  │   │
│  [批量处理]      │  └──────────────────────────────┘   │
│  [导出结果]      │                                      │
└──────────────────┴──────────────────────────────────────┘
```

### 功能模块设计

#### 1. 数据集管理模块
```
功能:
- 数据集统计展示
- 轨迹浏览与筛选
- 数据质量检查
- 数据导入/导出
```

#### 2. 模型训练模块
```
功能:
- 训练进度监控
- 损失曲线实时显示
- 超参数配置
- 模型版本管理
- TensorBoard集成
```

#### 3. 实时预测模块
```
功能:
- 单轨迹预测
- 批量预测
- 实时可视化
- 置信度分析
```

#### 4. 评估对比模块
```
功能:
- 多模型对比
- 指标统计表格
- 误差分布图
- 案例分析
```

#### 5. 可视化模块
```
功能:
- 2D地图展示
- 3D地形可视化
- 轨迹动画播放
- 热力图叠加
- 截图/录屏导出
```

### 交互设计

#### 地图交互
```
- 鼠标拖拽: 平移地图
- 滚轮: 缩放
- 点击: 选择轨迹
- 右键: 上下文菜单
- 框选: 批量选择
```

#### 轨迹编辑
```
- 添加历史点
- 删除历史点
- 修改起终点
- 手动绘制轨迹
```

#### 实时反馈
```
- 加载进度条
- 预测状态提示
- 错误提示
- 成功通知
```

---

## 🛠️ 技术栈

### 后端技术栈

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| **深度学习框架** | PyTorch 2.0+ | 模型训练与推理 |
| **地理数据处理** | GDAL, Rasterio | 栅格数据处理 |
| **数值计算** | NumPy, SciPy | 科学计算 |
| **机器学习** | XGBoost, scikit-learn | 速度预测 |
| **Web框架** | FastAPI | REST API服务 |
| **任务队列** | Celery + Redis | 异步任务处理 |
| **数据库** | PostgreSQL + PostGIS | 空间数据存储 |
| **缓存** | Redis | 结果缓存 |
| **监控** | TensorBoard, Prometheus | 训练监控 |

### 前端技术栈

| 组件 | 技术选型 | 用途 |
|------|---------|------|
| **框架** | React 18 + TypeScript | UI框架 |
| **地图** | Mapbox GL JS / Leaflet | 地图展示 |
| **可视化** | D3.js, ECharts | 数据可视化 |
| **UI组件** | Ant Design / Material-UI | UI组件库 |
| **状态管理** | Redux Toolkit | 状态管理 |
| **HTTP客户端** | Axios | API请求 |
| **3D渲染** | Three.js | 3D地形展示 |

### 部署架构

```
┌─────────────────────────────────────────┐
│           Nginx (负载均衡)               │
└─────────────────────────────────────────┘
              ↓           ↓
    ┌─────────────┐  ┌─────────────┐
    │  Web服务器  │  │  API服务器  │
    │  (React)    │  │  (FastAPI)  │
    └─────────────┘  └─────────────┘
                          ↓
              ┌──────────────────────┐
              │   模型推理服务        │
              │   (PyTorch Serve)    │
              └──────────────────────┘
                          ↓
              ┌──────────────────────┐
              │   GPU服务器          │
              │   (CUDA)             │
              └──────────────────────┘
```

---

## 📱 移动端设计 (可选)

### 功能简化版
```
- 轨迹查看
- 简单预测
- 结果展示
- 离线缓存
```

### 技术方案
```
- React Native / Flutter
- 轻量级模型 (模型压缩)
- 云端推理 + 本地缓存
```

---

## 🔒 安全设计

### 数据安全
- 敏感数据加密存储
- HTTPS通信
- API访问控制
- 数据备份策略

### 模型安全
- 模型版本控制
- 模型加密
- 推理结果验证
- 异常检测

---

## 📈 性能优化

### 模型优化
- 模型量化 (INT8)
- 模型剪枝
- 知识蒸馏
- ONNX导出

### 推理优化
- 批处理
- GPU加速
- 模型缓存
- 结果缓存

### 前端优化
- 代码分割
- 懒加载
- CDN加速
- 图片压缩

---

## 🚧 开发路线图

### Phase 1: 核心功能 (当前)
- ✅ 数据预处理管道
- ✅ TerraTNT模型实现
- ⏳ 模型训练
- ⏳ 基础评估

### Phase 2: 系统集成
- REST API开发
- 前端界面开发
- 数据库集成
- 基础可视化

### Phase 3: 功能完善
- 批量预测
- 多模型对比
- 高级可视化
- 性能优化

### Phase 4: 部署上线
- Docker容器化
- CI/CD流程
- 监控告警
- 文档完善

---

## 📝 总结

本系统采用五层架构设计，从数据层到用户交互层，实现了完整的地面目标轨迹预测流程。通过模块化设计和现代技术栈，确保系统的可扩展性、可维护性和高性能。

**核心优势:**
- 🎯 端到端的轨迹预测解决方案
- 🗺️ 多源地理数据融合
- 🤖 深度学习驱动的智能预测
- 📊 丰富的可视化和评估工具
- 🚀 高性能推理和部署方案
