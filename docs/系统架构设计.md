# TerraTNT 系统架构设计

## 📊 训练进度与模型性能

### 当前训练状态（2026-01-08 22:33）

#### ✅ 已完成训练（4/7 任务）

| 模型 | 完成时间 | 模型大小 | 训练轮次 | 状态 |
|:---|:---|:---|:---|:---|
| **Social-LSTM** | 18:20 | 7.6 MB | 早停 | ✅ 已完成 |
| **YNet** | 20:38 | 26 MB | 早停 | ✅ 已完成 |
| **PECNet** | 18:50 | 3.1 MB | 早停 | ✅ 已完成 |
| **Trajectron++** | 21:43 | 18 MB | 早停 | ✅ 已完成 |

#### 🔄 进行中（1/7 任务）

| 模型 | 阶段 | 启动时间 | 当前状态 | 预计完成 |
|:---|:---|:---|:---|:---|
| **TerraTNT** | FAS1 | 22:15 | Epoch 1/30 | 23:45 |

#### ⏳ 待完成（2/7 任务）

| 模型 | 阶段 | 预计开始 | 预计完成 |
|:---|:---|:---|:---|
| **TerraTNT** | FAS2 | 23:45 | 01:15 |
| **TerraTNT** | FAS3 | 01:15 | 02:30 |

**总预计完成时间**: **凌晨 2:30**

---

## 🏗️ 系统整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         TerraTNT 系统                            │
│              地面目标轨迹预测与可视化系统                         │
└─────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  交互层      │    │  应用层      │    │  数据层      │
│ (UI Layer)   │◄───┤(Application) │◄───┤(Data Layer)  │
└──────────────┘    └──────────────┘    └──────────────┘
                            │
                            ▼
                    ┌──────────────┐
                    │  模型层      │
                    │(Model Layer) │
                    └──────────────┘
```

---

## 📐 分层架构详细设计

### 1️⃣ 交互层 (UI Layer)

**职责**: 用户界面交互、数据可视化、参数配置

```
ui/
├── terratnt_professional_ui.py    # 主UI界面（PyQt5）
│   ├── TerraTNTMainWindow         # 主窗口
│   ├── SatelliteWidget            # 卫星星座配置
│   ├── DataGenerationWidget       # 数据生成控制
│   ├── DataLoadWidget             # 数据加载面板
│   ├── TrainingWidget             # 训练控制面板
│   ├── PredictionWidget           # 轨迹预测面板
│   └── VisualizationCanvas        # Matplotlib可视化画布
│
└── 功能特性:
    ├── 3D卫星星座可视化
    ├── DEM/LULC地形地貌显示
    ├── 轨迹路径可视化
    ├── 实时训练状态监控
    └── 参数配置与调整
```

**技术栈**:
- PyQt5: GUI框架
- Matplotlib: 数据可视化
- 中文字体支持: Noto Sans CJK SC

---

### 2️⃣ 应用层 (Application Layer)

**职责**: 业务逻辑、流程控制、任务调度

```
scripts/
├── 数据生成模块
│   ├── generate_dataset_parallel.py      # 并行轨迹生成
│   └── prepare_fas_datasets.py           # FAS数据集划分
│
├── 训练模块
│   ├── train_now.py                      # 基线模型训练
│   ├── train_terratnt_all_phases.py      # TerraTNT三阶段训练
│   └── training/
│       ├── trainer.py                    # 训练器基类
│       └── baseline_trainer.py           # 基线模型训练器
│
└── 评估模块
    └── evaluation/
        └── evaluator.py                  # 模型评估框架
```

**核心流程**:

```
数据生成流程:
用户配置 → 起终点采样 → 分层A*路径规划 → 路径平滑 
→ 速度预测 → 轨迹生成 → 保存PKL文件

训练流程:
数据加载 → 模型初始化 → 训练循环 → 验证 
→ 早停检查 → 保存最佳模型

评估流程:
加载模型 → FAS1/2/3数据准备 → 批量预测 
→ 计算ADE/FDE → 生成对比报告
```

---

### 3️⃣ 数据层 (Data Layer)

**职责**: 数据存储、预处理、加载

```
data/
├── raw/                              # 原始数据
│   ├── osm/                          # OpenStreetMap数据
│   ├── dem/                          # 数字高程模型
│   └── lulc/                         # 土地利用分类
│
├── processed/                        # 处理后数据
│   ├── utm_grid/                     # UTM投影栅格
│   │   ├── scottish_highlands/
│   │   │   ├── dem_utm.tif
│   │   │   └── lulc_utm.tif
│   │   └── bohemian_forest/
│   │
│   ├── synthetic_trajectories/       # 合成轨迹
│   │   ├── scottish_highlands/       # 3127条轨迹
│   │   └── bohemian_forest/
│   │
│   └── fas_splits/                   # FAS数据集划分
│       └── bohemian_forest/
│           └── fas_splits.json       # FAS1/2/3划分配置
│
└── 数据预处理模块:
    └── utils/data_processing/
        ├── trajectory_preprocessor.py    # 轨迹预处理
        └── environment_processor.py      # 环境数据处理
```

**数据格式**:

```python
# 轨迹PKL文件格式
{
    'path': [(x1, y1), (x2, y2), ...],      # UTM坐标序列
    'timestamps': [t1, t2, ...],             # 时间戳
    'vehicle_type': 'type1',                 # 车辆类型
    'intent': 'intent1',                     # 战术意图
    'goal_utm': (x_goal, y_goal)            # 终点坐标
}

# FAS划分JSON格式
{
    'fas1': {
        'files': [...],                      # 域内目标轨迹列表
        'num_samples': 2183
    },
    'fas2': {
        'files': [...],                      # 域外目标轨迹列表
        'num_samples': 944
    },
    'fas3': {
        'files': [...],                      # 域内目标+不完备候选
        'num_samples': 2183
    }
}
```

---

### 4️⃣ 模型层 (Model Layer)

**职责**: 深度学习模型、推理预测

```
models/
├── 基线模型
│   ├── baselines/
│   │   ├── base_predictor.py             # 基类
│   │   ├── constant_velocity.py          # 恒速模型
│   │   ├── social_lstm.py                # Social-LSTM
│   │   ├── ynet.py                       # YNet
│   │   ├── pecnet.py                     # PECNet
│   │   └── trajectron.py                 # Trajectron++
│   │
├── TerraTNT模型
│   └── terratnt.py
│       ├── CNNEnvironmentEncoder         # 环境编码器
│       ├── LSTMHistoryEncoder            # 历史编码器
│       ├── GoalClassifier                # 目标分类器
│       └── HierarchicalLSTMDecoder       # 层次化解码器
│
└── 辅助模型
    └── speed_predictor.py                # XGBoost速度预测
```

**TerraTNT 模型架构**:

```
输入:
├── 环境地图 (18通道, 128×128)
│   ├── DEM, Slope, Aspect (4通道)
│   ├── LULC one-hot (10通道)
│   ├── Road (1通道)
│   ├── History Heatmap (1通道)
│   └── Candidate Goal Map (2通道)
│
├── 历史轨迹 (10步, 2D坐标)
├── 候选终点 (6个, 2D坐标)
└── 当前位置 (2D坐标)

模型流程:
环境地图 → CNN编码器 → 环境特征 (256维)
                                    ↓
历史轨迹 → LSTM编码器 → 历史特征 (128维)
                                    ↓
候选终点 + 环境特征 + 历史特征 → 目标分类器 → 目标概率
                                    ↓
选择最优目标 + 环境特征 + 历史特征 → LSTM解码器 → 未来轨迹 (60步)

输出:
├── 预测轨迹 (60步, 2D坐标)
└── 目标概率 (6个候选的概率分布)
```

---

## 🔄 数据流图

```
┌─────────────┐
│  用户输入   │
│ (UI配置)    │
└──────┬──────┘
       │
       ▼
┌─────────────────────────────────────────┐
│         应用层 (业务逻辑)                │
├─────────────────────────────────────────┤
│  数据生成  │  模型训练  │  模型评估     │
└──────┬──────────┬──────────┬───────────┘
       │          │          │
       ▼          ▼          ▼
┌─────────────────────────────────────────┐
│         数据层 (数据管理)                │
├─────────────────────────────────────────┤
│  轨迹数据  │  环境数据  │  FAS划分      │
└──────┬──────────┬──────────┬───────────┘
       │          │          │
       └──────────┴──────────┘
                  │
                  ▼
┌─────────────────────────────────────────┐
│         模型层 (深度学习)                │
├─────────────────────────────────────────┤
│  基线模型  │  TerraTNT  │  速度预测    │
└──────┬──────────┬──────────┬───────────┘
       │          │          │
       └──────────┴──────────┘
                  │
                  ▼
┌─────────────┐
│  预测结果   │
│ (轨迹+指标) │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  UI可视化   │
│ (图表展示)  │
└─────────────┘
```

---

## 📊 模型性能对比（预期）

根据论文定义，三阶段评估的预期结果：

| 模型 | FAS1 ADE | FAS2 ADE | FAS3 ADE | 特点 |
|:---|:---|:---|:---|:---|
| **TerraTNT** | 1.23 km | 35.48 km | 1.24 km | 目标驱动，纠错能力强 |
| **YNet** | 1.35 km | 9.10 km | 20.35 km | 场景编码，性能均衡 |
| **PECNet** | 3.01 km | 4.10 km | 20.91 km | 泛化能力最强 |
| **Social-LSTM** | 4.83 km | 17.70 km | 4.83 km | 简单稳定 |
| **Trajectron++** | - | - | - | 概率预测 |

**关键发现**:
- **FAS1**: TerraTNT最优（域内目标，目标分类器准确）
- **FAS2**: PECNet最优（域外目标，不依赖候选机制）
- **FAS3**: TerraTNT最优（候选缺失，轨迹生成器纠错）

---

## 🔧 技术栈总览

### 核心框架
- **深度学习**: PyTorch 2.0+
- **数值计算**: NumPy, SciPy
- **地理信息**: GDAL, Rasterio, PyProj
- **机器学习**: XGBoost, Scikit-learn

### 界面与可视化
- **GUI**: PyQt5
- **绘图**: Matplotlib, Seaborn
- **3D可视化**: Matplotlib 3D

### 数据处理
- **路径规划**: 自实现分层A*
- **数据格式**: Pickle, JSON, GeoTIFF
- **并行计算**: Multiprocessing

### 开发工具
- **环境管理**: Conda
- **版本控制**: Git
- **日志记录**: Python logging

---

## 📁 项目目录结构

```
programwork/
├── data/                          # 数据目录
│   ├── raw/                       # 原始数据
│   └── processed/                 # 处理后数据
│
├── models/                        # 模型定义
│   ├── baselines/                 # 基线模型
│   └── terratnt.py                # TerraTNT模型
│
├── utils/                         # 工具函数
│   ├── data_processing/           # 数据处理
│   └── trajectory_generation/     # 轨迹生成
│
├── training/                      # 训练框架
│   ├── trainer.py                 # 训练器
│   └── baseline_trainer.py        # 基线训练器
│
├── evaluation/                    # 评估框架
│   └── evaluator.py               # 评估器
│
├── scripts/                       # 脚本
│   ├── generate_dataset_parallel.py
│   ├── prepare_fas_datasets.py
│   ├── train_now.py
│   └── train_terratnt_all_phases.py
│
├── ui/                            # 用户界面
│   └── terratnt_professional_ui.py
│
├── runs/                          # 训练输出
│   ├── social_lstm/
│   ├── ynet/
│   ├── pecnet/
│   ├── trajectron/
│   └── terratnt_fas{1,2,3}/
│
├── logs/                          # 日志文件
├── docs/                          # 文档
└── checkpoints/                   # 模型检查点
```

---

## 🎯 系统特点

### 优势
1. **模块化设计**: 各层职责清晰，易于维护和扩展
2. **数据驱动**: 完整的数据生成→训练→评估流程
3. **多模型对比**: 4个基线模型 + TerraTNT，全面评估
4. **三阶段评估**: FAS1/2/3覆盖不同难度场景
5. **可视化友好**: PyQt5专业UI，实时监控和结果展示

### 创新点
1. **目标驱动架构**: TerraTNT的候选终点机制
2. **环境约束融合**: 18通道环境地图编码
3. **层次化解码**: Waypoint机制抑制长时域误差
4. **合成数据生成**: 基于A*和XGBoost的高质量轨迹生成

---

## 📈 下一步工作

训练完成后（预计凌晨2:30）：

1. ✅ **统一评估框架开发**
   - 在FAS1/2/3三个阶段评估所有模型
   - 计算ADE/FDE指标
   - 生成对比表格和可视化

2. ✅ **结果分析**
   - 验证是否符合论文预期
   - 分析各模型优劣势
   - 生成实验报告

3. ✅ **系统完善**
   - UI功能补充
   - 文档完善
   - 代码优化

---

**文档版本**: 1.0  
**更新时间**: 2026-01-08 22:33  
**状态**: 训练进行中
