# FAS 三阶段评估框架正确定义

根据 `paper.txt` 第 1604-1621 行的明确描述：

## 表4.4 三阶段评估框架设计

| 阶段 | 目标点类型 | 候选集状态 | 评估目的 |
|:---|:---|:---|:---|
| **Phase 1** | **域内目标 (In-domain)** | **完备** (含真实目标) | 理想条件下的性能上界 |
| **Phase 2** | **域外目标 (Out-of-domain)** | **完备** (含真实目标) | 目标泛化能力 |
| **Phase 3** | **域内目标 (In-domain)** | **不完备** (缺失真实目标) | 候选缺失时的鲁棒性 |

## 关键理解

### Phase 1: 域内目标 + 完备候选集
- **目标点**：训练集中已见过的POI（例如训练时出现过的终点坐标）
- **候选集**：包含真实目标的候选点集合（例如 6 个候选点，其中一个是真值）
- **考察**：模型在理想条件下的性能上界，目标分类器能否准确识别正确终点

### Phase 2: 域外目标 + 完备候选集
- **目标点**：训练集中**未见过**的新POI（例如 "Linz Industrial Port"）
- **候选集**：仍然包含真实目标（虽然模型没见过这个终点，但候选集里有）
- **考察**：模型对未知目标的泛化能力，目标分类器能否识别从未见过的终点
- **重要**：这**不是跨区域**测试，仍在同一环境（Bohemian Forest 100km）

### Phase 3: 域内目标 + 不完备候选集
- **目标点**：训练集中已见过的POI（与 Phase 1 相同）
- **候选集**：**故意不包含真实目标**（例如 6 个候选点都是错的）
- **考察**：轨迹生成器的纠错能力，即使目标分类器选错了，解码器能否依靠历史轨迹和环境约束生成合理轨迹

## 实验数据来源（论文 1625-1627 行）

- **区域**：Bohemian Forest 100km 区域
- **Phase 1 验证集**：893 个样本（域内目标）
- **Phase 2 验证集**：912 个样本（域外目标 "Linz Industrial Port"）

## 数据集准备策略

### 1. 终点提取与标记
```python
# 从所有轨迹中提取终点坐标
all_goals = [traj['goal_utm'] for traj in trajectories]

# 划分训练集和测试集的终点
train_goals = set(train_trajectories 的终点)
test_goals = set(test_trajectories 的终点) - train_goals
```

### 2. Phase 1 数据准备
- 筛选终点在 `train_goals` 中的样本
- 生成候选集：1 个真值 + 5 个负采样（从 `train_goals` 中随机选择）

### 3. Phase 2 数据准备
- 筛选终点在 `test_goals` 中的样本
- 生成候选集：1 个真值 + 5 个负采样（可以从 `train_goals` 或其他位置选择）

### 4. Phase 3 数据准备
- 筛选终点在 `train_goals` 中的样本（与 Phase 1 相同）
- 生成候选集：6 个负采样（**不包含真值**）

## 评估指标

- **ADE (Average Displacement Error)**：平均位移误差
- **FDE (Final Displacement Error)**：最终位移误差

## 预期结果（论文表4.6-4.8）

| 模型 | Phase 1 ADE | Phase 2 ADE | Phase 3 ADE |
|:---|:---|:---|:---|
| TerraTNT | 1.23 km | 35.48 km | 1.24 km |
| YNet | 1.35 km | 9.10 km | 20.35 km |
| PECNet | 3.01 km | 4.10 km | 20.91 km |
| SimpleLSTM | 4.83 km | 17.70 km | 4.83 km |

### 关键观察
- **Phase 1**：TerraTNT 最优（目标分类器准确识别域内目标）
- **Phase 2**：PECNet 最优（不依赖候选机制，泛化能力强）
- **Phase 3**：TerraTNT 最优（轨迹生成器纠错能力强，不会盲目朝向错误目标）
