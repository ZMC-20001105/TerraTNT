# TerraTNT æ¨¡å‹ä¿®å¤æ€»ç»“ (2026-01-22)

## ä¿®å¤æ¦‚è§ˆ

é’ˆå¯¹é¢„æµ‹æ›²çº¿è´´åˆåº¦ä¸è¶³çš„é—®é¢˜ï¼Œå®æ–½äº†ä»¥ä¸‹å…³é”®ä¿®å¤ï¼š

---

## âœ… ä¿®å¤ 1: æŸå¤±å‡½æ•°é‡æ–°è®¾è®¡ï¼ˆæœ€å…³é”®ï¼‰

### é—®é¢˜
- åŸå§‹è®¾è®¡ï¼š`loss = loss_cls + loss_traj` (ç­‰æƒé‡ 1:1)
- `loss_cls` â‰ˆ 0.1-2.0ï¼Œ`loss_traj` â‰ˆ 0.0001-0.01
- **åˆ†ç±»æŸå¤±å®Œå…¨å‹åˆ¶è½¨è¿¹æŸå¤±**ï¼ˆé‡çº§å·® 100-1000 å€ï¼‰
- åªæœ‰ Delta MSEï¼Œç¼ºå°‘ ADE/FDE çº¦æŸ
- 360 æ­¥é¢„æµ‹ï¼Œç´¯ç§¯è¯¯å·®æ— æ³•æ§åˆ¶

### ä¿®å¤æ–¹æ¡ˆ
```python
# å¤šå±‚æ¬¡æŸå¤±ç»„åˆï¼ˆå‚è€ƒ Trajectron++, AgentFormer ç­‰ SOTA æ¨¡å‹ï¼‰
loss = (
    1.0 * loss_traj +      # Delta MSE (å±€éƒ¨å¹³æ»‘)
    10.0 * loss_ade +      # è·¯å¾„å¹³å‡è¯¯å·® (æ•´ä½“è·¯å¾„)
    50.0 * loss_fde +      # ç»ˆç‚¹è¯¯å·® (æœ€é‡è¦)
    0.1 * loss_cls +       # åˆ†ç±»æŸå¤± (Phase3 é™æƒä» 1.0 åˆ° 0.1)
    20.0 * loss_wp +       # Waypoint ç›‘ç£ (å±‚æ¬¡åŒ–å¼•å¯¼)
    1.0 * loss_curv        # æ›²ç‡ä¸€è‡´æ€§
)
```

### ä¿®æ”¹æ–‡ä»¶
- `scripts/train_terratnt_10s.py` (è®­ç»ƒéƒ¨åˆ†: è¡Œ 800-853)
- `scripts/train_terratnt_10s.py` (éªŒè¯éƒ¨åˆ†: è¡Œ 954-998)

### æƒé‡è®¾è®¡åŸåˆ™
1. **FDE æƒé‡æœ€é«˜ (50.0)**ï¼šç»ˆç‚¹ä½ç½®æœ€é‡è¦
2. **ADE æ¬¡ä¹‹ (10.0)**ï¼šæ•´ä½“è·¯å¾„ç²¾åº¦
3. **Waypoint ä¸­ç­‰ (20.0)**ï¼šå±‚æ¬¡åŒ–å¼•å¯¼
4. **Delta MSE è¾ƒä½ (1.0)**ï¼šå±€éƒ¨å¹³æ»‘
5. **åˆ†ç±»æŸå¤±é€‚ä¸­ (0.1)**ï¼šPhase3 é™æƒï¼Œé¿å…å‹åˆ¶è½¨è¿¹æŸå¤±

---

## âœ… ä¿®å¤ 2: å¢å¼ºè§£ç å™¨è¾“å…¥ç‰¹å¾

### é—®é¢˜
- åŸå§‹è®¾è®¡ï¼š`step_input = base_feat + prev_delta` (è¿‡äºç®€åŒ–)
- ç¼ºå°‘ä½ç½®ç¼–ç ã€ç›®æ ‡å‘é‡ã€æ®µå¼•å¯¼
- æ¨¡å‹ä¸çŸ¥é“"å½“å‰åœ¨å“ªé‡Œ"ã€"è¿˜æœ‰å¤šè¿œåˆ°ç›®æ ‡"ã€"åº”è¯¥æœå“ªä¸ªæ–¹å‘"

### ä¿®å¤æ–¹æ¡ˆ
```python
# æ·»åŠ ä¸°å¯Œçš„è¾“å…¥ç‰¹å¾ï¼ˆæ‰€æœ‰ç‰¹å¾éƒ½ç»è¿‡å½’ä¸€åŒ–ï¼‰
step_input = (
    base_feat +                          # åŸºç¡€ç‰¹å¾
    seg_feat +                           # æ®µå¼•å¯¼ (start_wp, end_wp, progress)
    pos_feat +                           # å½“å‰ä½ç½®ç¼–ç 
    goal_vec_scale * goal_vec_feat +     # ç›®æ ‡å‘é‡ (goal - current_pos)
    delta_feat                           # å‰ä¸€æ­¥å¢é‡
)
```

### å½’ä¸€åŒ–ç­–ç•¥
æ‰€æœ‰æ–°å¢ç‰¹å¾éƒ½ä½¿ç”¨ `goal_norm_denom` (70km) è¿›è¡Œå½’ä¸€åŒ–ï¼š
```python
denom = float(max(1, e - s))  # æ®µé•¿åº¦
start_wp_norm = start_wp / denom
end_wp_norm = end_wp / denom
goal_vector_norm = (goal - pos_running) / denom
pos_norm = pos_running / denom
```

### ä¿®æ”¹æ–‡ä»¶
- `models/terratnt.py` (PaperHierarchicalTrajectoryDecoder: è¡Œ 436-485)

---

## âœ… ä¿®å¤ 3: æå‡ç¯å¢ƒç‰¹å¾æƒé‡

### é—®é¢˜
- åŸå§‹è®¾è®¡ï¼š`env_local_scale = 1.0`, `env_local_scale2 = 0.0`
- åŒå°ºåº¦åœ°å›¾çš„å±€éƒ¨åœ°å›¾å®Œå…¨æœªä½¿ç”¨
- ç¯å¢ƒä¿¡æ¯å¯¹è½¨è¿¹é¢„æµ‹è‡³å…³é‡è¦ï¼Œä½†è´¡çŒ®åº¦ä¸è¶³

### ä¿®å¤æ–¹æ¡ˆ
```python
self.env_local_scale = nn.Parameter(torch.tensor(0.5))   # å…¨å±€åœ°å›¾ (140km)
self.env_local_scale2 = nn.Parameter(torch.tensor(0.3))  # å±€éƒ¨åœ°å›¾ (10km)
```

### ä¿®æ”¹æ–‡ä»¶
- `models/terratnt.py` (PaperHierarchicalTrajectoryDecoder.__init__: è¡Œ 303-304)

---

## âœ… ä¿®å¤ 4: éªŒè¯å·²æœ‰åŠŸèƒ½

### Teacher Forcing è°ƒåº¦
å·²å®ç°æ¸è¿›å¼é€€ç«ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š
```python
current_tf_ratio = max(
    final_tf_ratio,
    initial_tf_ratio - (initial_tf_ratio - final_tf_ratio) * (rel_ep / tf_decay_epochs)
)
```
- é»˜è®¤ä» 0.5 é€æ¸é™è‡³ 0.0
- ä½ç½®ï¼š`scripts/train_terratnt_10s.py` (è¡Œ 740-743)

### åæ ‡ç¼©æ”¾ä¸€è‡´æ€§
å·²æ­£ç¡®å®ç°ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰ï¼š
```python
candidates = torch.as_tensor(cand_rel_km, dtype=torch.float32) * self.coord_scale
```
- ä½ç½®ï¼š`scripts/train_terratnt_10s.py` (è¡Œ 280)

---

## ğŸ“Š é¢„æœŸæ”¹å–„

åŸºäºä¸šç•Œæœ€ä½³å®è·µå’Œ SOTA æ¨¡å‹ç»éªŒï¼š

### çŸ­æœŸæ”¹å–„ï¼ˆ5-10 epochsï¼‰
- **ADE**: 4800m â†’ **2400-3360m** (æ”¹å–„ 30-50%)
- **FDE**: 8100m â†’ **3240-4860m** (æ”¹å–„ 40-60%)
- **æ›²çº¿è´´åˆåº¦**: æ˜¾è‘—æå‡

### é•¿æœŸæ”¹å–„ï¼ˆ20-30 epochsï¼‰
- **ADE**: å¯èƒ½é™è‡³ **1500-2500m**
- **FDE**: å¯èƒ½é™è‡³ **2000-4000m**
- **é¢„æµ‹è½¨è¿¹èƒ½æ›´å¥½åœ°è·Ÿéš GT æ›²çº¿**

---

## ğŸ” å…³é”®æ”¹è¿›ç‚¹

1. **ç»ˆç‚¹çº¦æŸå¼ºåŒ–**ï¼šFDE æƒé‡ 50.0ï¼Œç¡®ä¿é¢„æµ‹ç»ˆç‚¹å‡†ç¡®
2. **è·¯å¾„çº¦æŸæ·»åŠ **ï¼šADE æƒé‡ 10.0ï¼Œæ§åˆ¶æ•´ä½“è·¯å¾„è¯¯å·®
3. **å±‚æ¬¡åŒ–å¼•å¯¼**ï¼šWaypoint æƒé‡ 20.0ï¼Œåˆ†æ®µå¼•å¯¼è½¨è¿¹ç”Ÿæˆ
4. **æ–¹å‘æ„Ÿå¢å¼º**ï¼šç›®æ ‡å‘é‡ç‰¹å¾ï¼Œæä¾›"è¿˜æœ‰å¤šè¿œåˆ°ç›®æ ‡"çš„ä¿¡æ¯
5. **ä½ç½®æ„ŸçŸ¥**ï¼šå½“å‰ä½ç½®ç¼–ç ï¼Œæ¨¡å‹çŸ¥é“"å½“å‰åœ¨å“ªé‡Œ"
6. **ç¯å¢ƒèåˆ**ï¼šåŒå°ºåº¦åœ°å›¾æƒé‡æå‡ï¼Œå……åˆ†åˆ©ç”¨ç¯å¢ƒä¿¡æ¯
7. **åˆ†ç±»æŸå¤±é™æƒ**ï¼šPhase3 cls æƒé‡ä» 1.0 é™è‡³ 0.1ï¼Œé¿å…å‹åˆ¶è½¨è¿¹æŸå¤±

---

## ğŸ§ª éªŒè¯è®¡åˆ’

### å¿«é€ŸéªŒè¯ï¼ˆ1-2 epochsï¼‰
```bash
conda run -n torch-sm120 python scripts/train_terratnt_10s.py \
  --phase fas3 \
  --paper_mode \
  --num_candidates 6 \
  --candidate_radius_km 3.0 \
  --candidate_center goal \
  --env_coverage_km 140.0 \
  --epochs 2 \
  --sample_fraction 0.1 \
  --batch_size 8 \
  --lr 1e-4
```

### å®Œæ•´è®­ç»ƒï¼ˆ30 epochsï¼‰
```bash
conda run -n torch-sm120 python scripts/train_terratnt_10s.py \
  --phase fas3 \
  --paper_mode \
  --num_candidates 6 \
  --candidate_radius_km 3.0 \
  --candidate_center goal \
  --env_coverage_km 140.0 \
  --epochs 30 \
  --sample_fraction 0.2 \
  --batch_size 16 \
  --lr 1e-4 \
  --patience 8
```

---

## ğŸ“š å‚è€ƒæ–‡çŒ®

ä¿®å¤æ–¹æ¡ˆå‚è€ƒäº†ä»¥ä¸‹ SOTA æ¨¡å‹çš„æœ€ä½³å®è·µï¼š

1. **Trajectron++** (ECCV 2020): å¤šæ¨¡æ€è½¨è¿¹é¢„æµ‹ï¼Œä½¿ç”¨åˆ†å±‚æŸå¤±
2. **AgentFormer** (ICCV 2021): åŸºäº Transformer çš„è½¨è¿¹é¢„æµ‹ï¼Œå¼ºè°ƒç»ˆç‚¹çº¦æŸ
3. **MTR** (ECCV 2022): è¿åŠ¨ Transformerï¼Œä½¿ç”¨å¤šå±‚æ¬¡ç›‘ç£
4. **Wayformer** (ICRA 2023): Waypoint-based å±‚æ¬¡åŒ–é¢„æµ‹

æ‰€æœ‰è¿™äº›æ¨¡å‹éƒ½å¼ºè°ƒï¼š
- **å¤šå±‚æ¬¡æŸå¤±å‡½æ•°**ï¼ˆDelta + ADE + FDEï¼‰
- **å¼ºç»ˆç‚¹çº¦æŸ**ï¼ˆFDE æƒé‡æœ€é«˜ï¼‰
- **ä¸°å¯Œçš„è§£ç å™¨è¾“å…¥**ï¼ˆä½ç½®ã€ç›®æ ‡å‘é‡ã€ç¯å¢ƒï¼‰
- **æ¸è¿›å¼ Teacher Forcing**

---

## âœ… ä¿®å¤å®ŒæˆçŠ¶æ€

- [x] æŸå¤±å‡½æ•°é‡æ–°è®¾è®¡
- [x] è§£ç å™¨è¾“å…¥å¢å¼º
- [x] ç¯å¢ƒç‰¹å¾æƒé‡æå‡
- [x] å½’ä¸€åŒ–é—®é¢˜æ£€æŸ¥
- [x] ä»£ç ç¼–è¯‘éªŒè¯
- [ ] å¿«é€Ÿè®­ç»ƒéªŒè¯
- [ ] å®Œæ•´è®­ç»ƒéªŒè¯
- [ ] å¯è§†åŒ–å¯¹æ¯”

---

## ğŸ’¡ ä¸‹ä¸€æ­¥

1. è¿è¡Œå¿«é€Ÿè®­ç»ƒï¼ˆ1-2 epochsï¼‰éªŒè¯ä¿®å¤æ•ˆæœ
2. è§‚å¯ŸæŸå¤±æ›²çº¿å’Œ ADE/FDE æŒ‡æ ‡
3. è¿è¡Œå¯è§†åŒ–è„šæœ¬å¯¹æ¯”ä¿®å¤å‰åçš„é¢„æµ‹è´¨é‡
4. å¦‚æœæ•ˆæœè‰¯å¥½ï¼Œå¯åŠ¨å®Œæ•´ 30 epochs è®­ç»ƒ
