# Phase System V2 设计文档

## 问题背景

多星协同对地观测系统中，卫星观测空窗期（60分钟）内的地面目标位置预测。

两类应用场景：
- **场景A（熟悉区域）**：有该区域历史轨迹数据，训练和测试同区域
- **场景B（陌生区域）**：只有地理数据（DEM/LULC/道路），模型在其他区域训练

关键约束：卫星视野较大，潜在区域<15km可直接覆盖，不需要预测。因此Phase体系关注的潜在区域≥15km。

## 核心设计：统一的区域先验输入

### 替代方案

旧方案：
- TerraTNT系列：离散候选点(K×2) + binary goal_map通道
- LSTM_Env_Goal：直接接收GT终点坐标(2D)
- 其他baseline：不接收终点信息

**问题**：不同模型接收的终点信息质量不一致，无法公平对比。

新方案：**所有模型通过env_map的第18通道（goal_prior_map）接收统一的区域先验热力图**。

- Phase 1：σ≈1km的尖锐高斯 → 精确终点
- Phase 2：σ≈10km的宽高斯 → 潜在区域（覆盖~20km）
- Phase 3：沿运动方向的扇形分布 → 无终点先验

### 热力图生成规则

所有热力图归一化到[0, 1]，最大值=1.0。

**Phase 1 热力图**：
```
center = GT终点坐标（相对于当前位置，km）
sigma = 1.0 km
heatmap[i,j] = exp(-dist(pixel_ij, center)^2 / (2*sigma^2))
```

**Phase 2 热力图**：
```
center = GT终点坐标（或偏移后的中心）
sigma = region_radius / 2  （如R=20km → σ=10km）
heatmap[i,j] = exp(-dist(pixel_ij, center)^2 / (2*sigma^2))
可选：乘以道路掩膜 road_mask，限制在道路上
```

**Phase 3 热力图**：
```
direction = 历史轨迹最后N步的运动方向
speed = 历史轨迹的平均速度（km/step）
est_distance = speed * future_len  （预估60分钟行驶距离）

扇形参数：
  角度范围 = direction ± 60°
  距离范围 = est_distance * [0.3, 2.0]

heatmap[i,j] = 1.0 if pixel_ij在扇形内且在道路上, else 0.0
归一化到max=1.0
```

### TerraTNT系列的候选采样

TerraTNT的分类器仍然需要离散候选点。从热力图中采样：
```
1. 将热力图值作为采样权重
2. 在道路像素上按权重采样K个候选点
3. 送入分类器打分
```

这样候选点的分布自然反映了先验信息的质量。

## Phase定义

### Phase 1：精确终点已知（Precise Goal）

| 项目 | 内容 |
|---|---|
| 场景 | 情报精确，已知目标终点 |
| 热力图 | σ=1km高斯，中心=GT终点 |
| TerraTNT候选 | 从热力图采样6个+GT插入，GT一定在候选中 |
| 测试能力 | 纯轨迹生成质量 |
| 预期ADE | 800-1500m |

子实验：
- **1a 域内**：fas1样本（训练分布内）
- **1b OOD**：fas2样本（域外终点分布）

### Phase 2：潜在区域已知（Region Prior）

| 项目 | 内容 |
|---|---|
| 场景 | 情报粗略，知道目标在某区域内 |
| 热力图 | σ=10km高斯，中心=GT终点（或偏移） |
| TerraTNT候选 | 从热力图采样6个，GT不在候选中 |
| 测试能力 | 区域先验下的预测退化 |
| 预期ADE | 2500-6000m |

子实验：
- **2a 标准区域**：σ=10km，中心=GT
- **2b 大区域**：σ=15km，中心=GT
- **2c 偏移区域**：σ=10km，中心偏离GT 5-10km

### Phase 3：无终点先验（No Prior）

| 项目 | 内容 |
|---|---|
| 场景 | 完全不知道目标去哪 |
| 热力图 | 运动方向±60°扇形分布 |
| TerraTNT候选 | 从扇形道路区域采样6个 |
| 测试能力 | 无先验下限 |
| 预期ADE | 3000-10000m |

子实验：
- **3a 直行**：目标沿历史方向继续（GT在扇形内）
- **3b 转弯**：目标改变方向（GT不在扇形内）

## 数据分割

使用现有fas_splits：
- Phase 1a / 2a / 2b / 2c / 3a / 3b：均使用fas1样本（域内）
- Phase 1b：使用fas2样本（OOD）

Phase 3a/3b的区分：根据历史轨迹方向与实际终点方向的夹角：
- 夹角 < 30°：直行样本（3a）
- 夹角 > 60°：转弯样本（3b）

## 模型适配

所有模型统一接口：
```python
# 输入
env_map: (B, 18, 128, 128)  # 第18通道=先验热力图
history: (B, 90, 26)
candidates: (B, K, 2)  # 仅TerraTNT系列使用

# 对于LSTM_Env_Goal：
# 旧：goal = GT终点坐标
# 新：goal = 从热力图提取的"最可能终点"（热力图最大值位置）
# 或者：去掉单独的goal输入，完全依赖env_map的热力图通道
```
