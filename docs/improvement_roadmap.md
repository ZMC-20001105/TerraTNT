# TerraTNT 改进方向路线图

> 更新时间: 2026-02-12

## 当前性能基线（Phase评估结果）

| Phase | 最佳模型 | ADE (m) | 说明 |
|:------|:---------|:--------|:-----|
| FAS1 (GT候选) | V6 | 973 | 精确终点已知 |
| FAS2 (OOD候选) | LSTM_Env_Goal | 2027 | 候选不含GT |
| FAS3 (缺失GT) | V6R | 1208 | GT不在候选中 |
| FAS3B (高斯先验σ=10km) | LSTM_Env_Goal | 1440 | 区域级先验 |
| FAS4 (无先验, r=40km) | LSTM_Env_Goal | 1451 | 无任何终点信息 |

**核心发现**: Phase4下所有goal-dependent模型崩溃(ADE 12-13km)，仅LSTM_Env_Goal保持稳定(~1.4km)。

---

## 一、模型架构改进

### 1.1 CVAE终点预测器 ⭐⭐⭐ [优先级: 最高]
- **目标**: 从历史轨迹+环境地图预测终点分布，替代Phase3/4的候选生成
- **方法**: 条件变分自编码器(CVAE)，训练时用GT终点作后验，推理时从先验采样
- **参考**: PECNet (ECCV 2020), MUSE-VAE (CVPR 2022)
- **预期收益**: 大幅改善Phase4 (ADE从12km降至2-3km)
- **实现复杂度**: 中等
- **状态**: 🔲 未开始

### 1.2 方向意图预测器 ⭐⭐ [优先级: 高]
- **目标**: 预测未来大致移动方向(8方向分类+角度回归+距离回归)
- **方法**: CNN环境编码+LSTM历史编码 → 分类/回归头
- **用途**: 为Phase3a生成更好的方向性先验热力图
- **预期收益**: 改善Phase3/4的候选质量
- **实现复杂度**: 低
- **状态**: 🔶 脚本已写好 (`scripts/train_direction_predictor.py`)，待训练

### 1.3 多尺度分层预测 (MUSE-VAE式) ⭐⭐ [优先级: 高]
- **目标**: Macro(终点) → Meso(路标) → Micro(轨迹) 三级预测
- **方法**: 
  - Macro-CVAE: 预测终点区域(σ~5-10km)
  - Meso: 终点+环境 → 中间waypoints
  - Micro: waypoints → 完整轨迹(现有V6已有此能力)
- **参考**: MUSE-VAE (CVPR 2022)
- **预期收益**: 长时域预测更合理，中间路径更平滑
- **实现复杂度**: 高
- **状态**: 🔲 未开始

### 1.4 Diffusion轨迹生成 ⭐⭐ [优先级: 中]
- **目标**: 用扩散模型建模轨迹分布，天然支持多模态
- **方法**: 条件扩散模型，以历史+环境+终点为条件
- **参考**: MID (CVPR 2022), LED (CVPR 2023)
- **预期收益**: 更好的多模态覆盖，轨迹多样性
- **实现复杂度**: 高
- **状态**: 🔲 未开始

### 1.5 Transformer编码器 ⭐ [优先级: 低]
- **目标**: 用多尺度时间注意力替代LSTM编码器
- **方法**: 位置编码+多头自注意力，捕捉不同时间尺度的运动模式
- **预期收益**: 中等，可能改善长序列建模
- **实现复杂度**: 中等
- **状态**: 🔲 未开始

### 1.6 DenseTNT式密集终点评分 ⭐ [优先级: 低]
- **目标**: 在环境地图上密集采样终点，用网络评分
- **方法**: anchor-free，端到端学习终点分布
- **参考**: DenseTNT (ICCV 2021)
- **问题**: 空间范围大(140km)，密集采样计算量大
- **状态**: 🔲 未开始

---

## 二、训练策略改进

### 2.1 环境可达性约束损失 ⭐⭐⭐ [优先级: 最高]
- **目标**: 惩罚预测轨迹经过不可通行区域(水体、陡坡等)
- **方法**: 在loss中加入cost map采样惩罚项
- **预期收益**: 减少物理不合理的预测
- **实现复杂度**: 低
- **状态**: 🔲 未开始

### 2.2 课程学习 (Curriculum Learning) ⭐⭐ [优先级: 高]
- **目标**: 从简单样本(短距离/直线)逐步过渡到困难样本(长距离/弯曲)
- **方法**: 按轨迹复杂度排序，分阶段训练
- **预期收益**: 更稳定的训练，改善困难样本表现
- **实现复杂度**: 低
- **状态**: 🔲 未开始

### 2.3 对比学习预训练 ⭐⭐ [优先级: 中]
- **目标**: 环境编码器自监督预训练，学习更好的地形表示
- **方法**: 相似地形patch拉近，不同地形push away
- **预期收益**: 更好的环境特征，尤其在数据稀疏区域
- **实现复杂度**: 中等
- **状态**: 🔲 未开始

### 2.4 数据增强 ⭐ [优先级: 中]
- **目标**: 增加训练数据多样性
- **方法**: 
  - 轨迹旋转/翻转(需同步旋转环境地图)
  - 时间扰动(随机丢帧/插帧)
  - 噪声注入(GPS噪声模拟)
- **预期收益**: 低-中，改善泛化
- **实现复杂度**: 低
- **状态**: 🔲 未开始

### 2.5 混合Phase训练 ⭐⭐ [优先级: 高]
- **目标**: 在单次训练中混合不同Phase的数据，让模型自适应
- **方法**: 随机选择Phase配置(精确/模糊/无先验)，配合V7的置信度门控
- **预期收益**: 单模型跨Phase鲁棒性
- **实现复杂度**: 低
- **状态**: 🔲 未开始 (V7已有门控机制，需配合训练策略)

---

## 三、后处理与推理改进

### 3.1 环境约束后处理 ⭐⭐ [优先级: 高]
- **目标**: 推理后将轨迹"吸附"到可通行区域
- **方法**: 
  - 方案A: 基于cost map的梯度下降微调
  - 方案B: 最近可通行点投影
  - 方案C: A*局部重规划
- **预期收益**: 消除明显不合理预测
- **实现复杂度**: 低-中
- **状态**: 🔲 未开始

### 3.2 多模型集成 ⭐ [优先级: 低]
- **目标**: 融合多个模型的预测结果
- **方法**: 加权平均或选择性融合(按Phase选最优模型)
- **预期收益**: 低，但稳定性提升
- **实现复杂度**: 低
- **状态**: 🔲 未开始

### 3.3 自适应Phase选择 ⭐⭐ [优先级: 中]
- **目标**: 根据可用信息自动选择最优Phase配置
- **方法**: 元学习或规则引擎
- **预期收益**: 实际部署时的智能决策
- **实现复杂度**: 中等
- **状态**: 🔲 未开始

---

## 四、数据与工程改进

### 4.1 扩展区域环境数据 ⭐⭐ [优先级: 高]
- **目标**: 覆盖更多地形类型(山地、平原、极地等)
- **当前**: bohemian_forest (112×114km), scottish_highlands (125×226km)
- **待扩展**: donbas, carpathians, ardennes, norway_finnmark
- **下载脚本**: `scripts/download_new_regions.py` 已就绪
- **状态**: 🔶 脚本已就绪，待执行

### 4.2 扩大现有区域范围 ⭐⭐ [优先级: 高]
- **目标**: 现有区域边缘轨迹超出环境数据范围
- **方法**: 重新下载更大范围的DEM/LULC数据
- **状态**: 🔲 未开始

### 4.3 真实轨迹数据集 ⭐⭐⭐ [优先级: 高]
- **目标**: 用OORD等真实数据验证模型泛化能力
- **当前**: 仅用合成轨迹训练和评估
- **方法**: OORD数据预处理 → 统一格式 → 迁移评估
- **状态**: 🔲 未开始

### 4.4 脏数据过滤增强 ⭐ [优先级: 低]
- **目标**: 更精细的数据质量控制
- **当前**: 已过滤直角贴边轨迹
- **待做**: 过滤原地打转、速度异常等
- **状态**: 🔶 基础过滤已实现

---

## 五、可视化与UI改进

### 5.1 预测不确定性可视化 ⭐⭐ [优先级: 中]
- **目标**: 显示预测轨迹的置信区间/不确定性椭圆
- **状态**: 🔲 未开始

### 5.2 多模态轨迹显示 ⭐⭐ [优先级: 中]
- **目标**: 同时显示多条可能的未来轨迹
- **状态**: 🔲 未开始

### 5.3 实时卫星底图 ⭐ [优先级: 低]
- **目标**: 在线加载卫星影像作为底图
- **当前**: 已有tile_fetcher但未完全集成
- **状态**: 🔶 部分实现

---

## 实施优先级排序

| 优先级 | 改进项 | 预期收益 | 工作量 |
|:-------|:-------|:---------|:-------|
| 🔴 P0 | CVAE终点预测器 | Phase4 ADE 12km→2-3km | 3-5天 |
| 🔴 P0 | 环境可达性约束损失 | 减少不合理预测 | 1-2天 |
| 🟠 P1 | 方向意图预测器 | Phase3/4候选质量 | 1-2天 |
| 🟠 P1 | 混合Phase训练 | 跨Phase鲁棒性 | 1-2天 |
| 🟠 P1 | 环境约束后处理 | 消除不合理预测 | 2-3天 |
| 🟡 P2 | 多尺度分层预测 | 长时域合理性 | 5-7天 |
| 🟡 P2 | 课程学习 | 训练稳定性 | 1天 |
| 🟡 P2 | 扩展区域数据 | 泛化能力 | 2-3天 |
| 🟢 P3 | Diffusion轨迹生成 | 多模态覆盖 | 7-10天 |
| 🟢 P3 | 对比学习预训练 | 环境特征质量 | 3-5天 |
| 🟢 P3 | 数据增强 | 泛化 | 1-2天 |
